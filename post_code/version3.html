<html>
<head>
<title>Test Urban FoodService Integration</title>
</head>
<body>
<h1>Test Urban FoodService Integration</h1>
<input type="text" id="postcodeInput" placeholder="Eg. SE7 2AZ">
<button type="submit" id="PSTCD_Check">Submit</button>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.2.min.js"></script>

<script>

// basic validation and parse functions
function postcode_valid(postcode) {
    var regex = /^[A-Z]{1,2}[0-9]{1,2} [0-9][A-Z]{2}$/i;
    return regex.test(postcode);
}

function postcode_area(postcode) {
    return postcode.split(" ")[0];
}

// AJAX technical handling
var AREAS_ALLOWED_LIST_URL="https://raw.githubusercontent.com/htssouza/food/master/post_code/areas_allowed.txt";
var global_postcode = null;
var global_area = null;
var global_found_handler = null;
var global_not_found_handler = null;

function area_allowed_ajax_success(data) {
    alert(data);
}

function area_allowed_ajax_fail() {
  alert("Failed to check post code, please try again later.");
}

function area_allowed_ajax(postcode, found_handler, not_found_handler) {
    global_postcode = postcode;
    global_area = postcode_area(postcode);
    global_found_handler = found_handler;
    global_not_found_handler = not_found_handler;
    $.ajax({
        url: AREAS_ALLOWED_LIST_URL,
        success: area_allowed_ajax_success,
        fail: area_allowed_ajax_fail});
}

// AJAX actions
function area_allowed_ajax_found(postcode, area) {
    var newUrl = "https://shop.urbanfoodservice.co.uk/auth/register.aspx?Postcode=";
    newUrl = newUrl + encodeURIComponent(postcode);
    window.location = newUrl;
}

function area_allowed_ajax_not_found(postcode, area) {
    alert("Sorry, we donâ€™t currently deliver to the " + area + " area yet.");
}

// button handler
(function ($) {
    function bindSubmitButton() {
        $("#PSTCD_Check").click(function() {
            var postcode = $("#postcodeInput").val().trim();
            if (! postcode_valid(postcode)) {
                alert("Please enter a valid post code including the space.");
                return;
            }
            area_allowed_ajax(postcode,
                              area_allowed_ajax_found,
                              area_allowed_ajax_not_found);  
        });
    }
    $(document).ready(function() {
      bindSubmitButton();
    });
}(jQuery));
</script>
</body>
</html>

