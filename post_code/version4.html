<html>
<head>
<title>Test Urban FoodService Integration</title>
</head>
<body>
<h1>Test Urban FoodService Integration</h1>
<input type="text" id="postcodeInput" placeholder="Eg. SE7 2AZ">
<button type="submit" id="PSTCD_Check">Submit</button>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.2.min.js"></script>

<script>

function postcode_valid(postcode) {
    var regex = /^[A-Z]{1,2}[0-9]{1,2} [0-9][A-Z]{2}$/i;
    return regex.test(postcode);
}

function postcode_area(postcode) {
    return postcode.split(" ")[0];
}

var AREAS_LIST_URL="https://raw.githubusercontent.com/htssouza/food/master/post_code/areas_list.txt";
var global_postcode = null;
var global_area = null;
var global_allowed_handler = null;
var global_not_allowed_handler = null;

function area_list_ajax_success(data) {
    data = data.toUpperCase();
    area = global_area.toUpperCase();
    var found = false;
    var lines = data.split("\n");
    for(var index = 0; index < lines.length; index++) {
        if (lines[index] == area) {
            found = true;
            break;
        }
    }
    if (found) {
        global_found_handler(global_postcode, global_area);
    } else {
        global_not_found_handler(global_postcode, global_area);
    }
}

function area_list_ajax_fail() {
  alert("Failed to check post code, please try again later.");
}

function area_list_ajax(postcode, found_handler, not_found_handler) {
    global_postcode = postcode;
    global_area = postcode_area(postcode);
    global_found_handler = found_handler;
    global_not_found_handler = not_found_handler;
    $.ajax({
        url: AREAS_BLACK_LIST_URL,
        success: area_list_ajax_success,
        fail: area_list_ajax_fail});
}

function area_list_found(postcode, area) {
    alert("Sorry, we don't currently deliver to the " + area + " area yet.");
}

function area_list_not_found(postcode, area) {
    var newUrl = "https://shop.urbanfoodservice.co.uk/auth/register.aspx?Postcode=";
    newUrl = newUrl + encodeURIComponent(postcode);
    window.location = newUrl;
}

(function ($) {
    function bindSubmitButton() {
        $("#PSTCD_Check").click(function() {
            var postcode = $("#postcodeInput").val().trim().toUpperCase();
            if (! postcode_valid(postcode)) {
                alert("Please enter a valid post code including the space.");
                return;
            }
            area_list_ajax(postcode, area_list_found, area_list_not_found);  
        });
    }
    $(document).ready(function() {
      bindSubmitButton();
    });
}(jQuery));
</script>
</body>
</html>

